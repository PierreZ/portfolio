<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Notes about ETCD - Pierre Zemb</title><meta name="Description" content="List of ressources gleaned about ETCD"><meta property="og:title" content="Notes about ETCD" />
<meta property="og:description" content="List of ressources gleaned about ETCD" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pierrezemb.fr/posts/notes-about-etcd/" /><meta property="og:image" content="https://pierrezemb.fr/posts/notes-about-etcd/images/etcd.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-11T00:24:27+01:00" />
<meta property="article:modified_time" content="2021-01-11T00:24:27+01:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://pierrezemb.fr/posts/notes-about-etcd/images/etcd.png"/>

<meta name="twitter:title" content="Notes about ETCD"/>
<meta name="twitter:description" content="List of ressources gleaned about ETCD"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest">
<link rel="canonical" href="https://pierrezemb.fr/posts/notes-about-etcd/" />
<link rel="prev" href="https://pierrezemb.fr/posts/ten-years-programming/" /><link rel="next" href="https://pierrezemb.fr/posts/crafting-keys-in-fdb/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script defer data-domain="pierrezemb.fr" src="https://plausible.io/js/plausible.js"></script><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Notes about ETCD",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/pierrezemb.fr\/posts\/notes-about-etcd\/"
        },"genre": "posts","wordcount":  2034 ,
        "url": "https:\/\/pierrezemb.fr\/posts\/notes-about-etcd\/","datePublished": "2021-01-11T00:24:27+01:00","dateModified": "2021-01-11T00:24:27+01:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Pierre Zemb"
            },"description": "List of ressources gleaned about ETCD"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Pierre Zemb">~/blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/posts/"> Blog </a><a class="menu-item" href="/podcasts/">️ Podcasts </a><a class="menu-item" href="/talks/"> Talks </a><a class="menu-item" href="/categories/">️ Categories </a><a class="menu-item" href="/cv.pdf"> Resume </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Pierre Zemb">~/blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/posts/" title="">Blog</a><a class="menu-item" href="/podcasts/" title="">️Podcasts</a><a class="menu-item" href="/talks/" title="">Talks</a><a class="menu-item" href="/categories/" title="">️Categories</a><a class="menu-item" href="/cv.pdf" title="">Resume</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Notes about ETCD</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Pierre Zemb</a></span>&nbsp;<span class="post-category">included in <a href="/categories/etcd/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>etcd</a>&nbsp;<a href="/categories/notesabout/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>notesabout</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-01-11">2021-01-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2034 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;10 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#overview-of-etcd">Overview of ETCD</a></li>
    <li><a href="#history">History</a></li>
    <li><a href="#overall-architecture">Overall architecture</a>
      <ul>
        <li><a href="#consensus-raft">Consensus? Raft?</a></li>
        <li><a href="#exposed-api">Exposed API</a></li>
        <li><a href="#transactions">Transactions</a></li>
        <li><a href="#versioned-data">Versioned data</a></li>
        <li><a href="#lease">Lease</a></li>
        <li><a href="#watches">Watches</a></li>
        <li><a href="#linearizable-reads">Linearizable reads</a></li>
        <li><a href="#how-etcd-is-using-bbolt">How ETCD is using bbolt</a></li>
      </ul>
    </li>
    <li><a href="#etcd-in-k8s">ETCD in K8S</a></li>
    <li><a href="#jepsen">Jepsen</a></li>
    <li><a href="#operation-notes">Operation notes</a>
      <ul>
        <li><a href="#deployements-tips">Deployements tips</a></li>
        <li><a href="#defrag">Defrag</a></li>
        <li><a href="#snapshot">Snapshot</a></li>
        <li><a href="#lease-1">Lease</a></li>
        <li><a href="#war-stories">War stories</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-etcd/images/etcd.png"
        data-srcset="/posts/notes-about-etcd/images/etcd.png, /posts/notes-about-etcd/images/etcd.png 1.5x, /posts/notes-about-etcd/images/etcd.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-etcd/images/etcd.png"
        title="etcd image" /></p>
<p><a href="/tags/notesabout/" rel="">Notes About</a> is a blogpost serie  you will find a lot of <strong>links, videos, quotes, podcasts to click on</strong> about a specific topic. Today we will discover ETCD.</p>
<h2 id="overview-of-etcd">Overview of ETCD</h2>
<p>As stated in the <a href="https://etcd.io/" target="_blank" rel="noopener noreffer ">official documentation</a>:</p>
<blockquote>
<p>etcd is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines. It gracefully handles leader elections during network partitions and can tolerate machine failure, even in the leader node.</p>
</blockquote>
<h2 id="history">History</h2>
<p>ETCD was initially developed by CoreOS:</p>
<blockquote>
<p>CoreOS built etcd to solve the problem of shared configuration and service discovery.</p>
</blockquote>
<ul>
<li>July 23, 2013 - announcement</li>
<li>December 27, 2013 - etcd 0.2.0 - new API, new modules and tons of improvements</li>
<li>February 07, 2014 - etcd 0.3.0 - Improved Cluster Discovery, API Enhancements and Windows Support</li>
<li>January 28, 2015 - etcd 2.0 - First Major Stable Release</li>
<li>June 30, 2016 - etcd3 - A New Version of etcd from CoreOS</li>
<li>June 09, 2017 - etcd 3.2 - etcd 3.2 now with massive watch scaling and easy locks</li>
<li>February 01, 2018 - etcd 3.3 - Announcing etcd 3.3, with improvements to stability, performance, and more</li>
<li>August 30, 2019 - etcd 3.4 - Better Storage Backend, concurrent Read, Improved Raft Voting Process, Raft Learner Member</li>
</ul>
<h2 id="overall-architecture">Overall architecture</h2>
<blockquote>
<p>The etcd key-value store is a distributed system intended for use as a coordination primitive. Like Zookeeper and Consul, etcd stores a small volume of infrequently-updated state (by default, up to 8 GB) in a key-value map, and offers strict-serializable reads, writes and micro-transactions across the entire datastore, plus coordination primitives like locks, watches, and leader election. Many distributed systems, such as Kubernetes and OpenStack, use etcd to store cluster metadata, to coordinate consistent views over data, to choose leaders, and so on.</p>
</blockquote>
<p>ETCD is:</p>
<ul>
<li>using <a href="/posts/notes-about-raft/" rel="">the raft consensus algorithm</a>,</li>
<li>a single group raft,</li>
<li>using <a href="https://grpc.io/" target="_blank" rel="noopener noreffer ">gRPC</a> for communication,</li>
<li>using a self-made WAL implementation,</li>
<li>storing key-values into bbolt,</li>
<li>optimized for consistency over latency in normal situations and consistency over availability in the case of a partition (<a href="https://en.wikipedia.org/wiki/PACELC_theorem" target="_blank" rel="noopener noreffer ">in terms of the PACELC theorem</a>).</li>
</ul>
<h3 id="consensus-raft">Consensus? Raft?</h3>
<ul>
<li>Raft is a consensus algorithm for managing a replicated log.</li>
<li>consensus involves multiple servers agreeing on values.</li>
<li>two common consensus algorithm are Paxos and Raft</li>
</ul>
<blockquote>
<p>, Paxos is quite difficult to understand, inspite of numerous attempts to make it more approachable.Furthermore, its architecture requires complex changes to support practical systems. As a result, both system builders and students struggle with Paxos.</p>
</blockquote>
<ul>
<li>A common alternative to Paxos/Raft is a non-consensus (aka peer-to-peer) replication protocol.</li>
</ul>
<blockquote>
<p>Raft separates the key elements of consensus, such asleader election, log replication, and safety</p>
</blockquote>
<p>ETCD contains several raft optimizations:</p>
<ul>
<li>Read Index,</li>
<li>Follower reads,</li>
<li>Transfer leader,</li>
<li>Learner role,</li>
<li>Client-side load-balancing.</li>
</ul>
<h3 id="exposed-api">Exposed API</h3>
<p>ETCD is exposing several APIs through different gRPC services:</p>
<ul>
<li>Put(key, value),</li>
<li>Delete(key, Optional(keyRangeEnd)),</li>
<li>Get(key, Optional(keyRangeEnd)),</li>
<li>Watch(key, Optional(keyRangeEnd)),</li>
<li>Transaction(if/then/else ops),</li>
<li>Compact(revision),</li>
<li>Lease:
<ul>
<li>Grant,</li>
<li>Revoke,</li>
<li>KeepAlive</li>
</ul>
</li>
</ul>
<p>Key and values are bytes-oriented but ordered.</p>
<h3 id="transactions">Transactions</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="c1">// From google paxosdb paper:
</span></span></span><span class="line"><span class="cl"><span class="c1">// Our implementation hinges around a powerful primitive which we call MultiOp. All other database
</span></span></span><span class="line"><span class="cl"><span class="c1">// operations except for iteration are implemented as a single call to MultiOp. A MultiOp is applied atomically
</span></span></span><span class="line"><span class="cl"><span class="c1">// and consists of three components:
</span></span></span><span class="line"><span class="cl"><span class="c1">// 1. A list of tests called guard. Each test in guard checks a single entry in the database. It may check
</span></span></span><span class="line"><span class="cl"><span class="c1">// for the absence or presence of a value, or compare with a given value. Two different tests in the guard
</span></span></span><span class="line"><span class="cl"><span class="c1">// may apply to the same or different entries in the database. All tests in the guard are applied and
</span></span></span><span class="line"><span class="cl"><span class="c1">// MultiOp returns the results. If all tests are true, MultiOp executes t op (see item 2 below), otherwise
</span></span></span><span class="line"><span class="cl"><span class="c1">// it executes f op (see item 3 below).
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. A list of database operations called t op. Each operation in the list is either an insert, delete, or
</span></span></span><span class="line"><span class="cl"><span class="c1">// lookup operation, and applies to a single database entry. Two different operations in the list may apply
</span></span></span><span class="line"><span class="cl"><span class="c1">// to the same or different entries in the database. These operations are executed
</span></span></span><span class="line"><span class="cl"><span class="c1">// if guard evaluates to
</span></span></span><span class="line"><span class="cl"><span class="c1">// true.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3. A list of database operations called f op. Like t op, but executed if guard evaluates to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">message</span> <span class="nc">TxnRequest</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// compare is a list of predicates representing a conjunction of terms.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// If the comparisons succeed, then the success requests will be processed in order,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and the response will contain their respective responses in order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// If the comparisons fail, then the failure requests will be processed in order,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and the response will contain their respective responses in order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">repeated</span> <span class="n">Compare</span> <span class="n">compare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// success is a list of requests which will be applied when compare evaluates to true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">repeated</span> <span class="n">RequestOp</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// failure is a list of requests which will be applied when compare evaluates to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">repeated</span> <span class="n">RequestOp</span> <span class="n">failure</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><h3 id="versioned-data">Versioned data</h3>
<p>Each Key/Value has a revision. When creating a new key, revision starts at 1, and then will be incremented each time the key is updated.</p>
<p>In order to avoid having a growing keySpace, one can issue the <code>Compact</code> gRPC service:</p>
<blockquote>
<p>Compacting the keyspace history drops all information about keys superseded prior to a given keyspace revision</p>
</blockquote>
<h3 id="lease">Lease</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="c1">// this message represent a Lease
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">message</span> <span class="nc">Lease</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// TTL is the advisory time-to-live in seconds. Expired lease will return -1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int64</span> <span class="n">TTL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// ID is the requested ID for the lease. If ID is set to 0, the lessor chooses an ID.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int64</span> <span class="n">ID</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">insert_timestamp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><h3 id="watches">Watches</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="kd">message</span> <span class="nc">Watch</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// key is the key to register for watching.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bytes</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// range_end is the end of the range [key, range_end) to watch. If range_end is not given,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// only the key argument is watched. If range_end is equal to &#39;\0&#39;, all keys greater than
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// or equal to the key argument are watched.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// If the range_end is one bit larger than the given key,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// then all keys with the prefix (the given key) will be watched.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bytes</span> <span class="n">range_end</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="c1">// If watch_id is provided and non-zero, it will be assigned to this watcher.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Since creating a watcher in etcd is not a synchronous operation,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// this can be used ensure that ordering is correct when creating multiple
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// watchers on the same stream. Creating a watcher with an ID already in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// use on the stream will cause an error to be returned.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int64</span> <span class="n">watch_id</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><h3 id="linearizable-reads">Linearizable reads</h3>
<p>Section 8 of the raft paper explains the issue:</p>
<blockquote>
<p>Read-only operations can be handled without writing anything into the log. However, with no additional measures, this would run the risk of returning stale data, since the leader responding to the request might have been superseded by a newer leader of which it is unaware. Linearizable reads must not return stale data, and Raft needs two extra precautions to guarantee this without using the log. First, a leader must have the latest information on which entries are committed. The Leader Completeness Property guarantees that a leader has all committed entries, but at the start of its term, it may not know which those are. To find out, it needs to commit an entry from its term. Raft handles this by having each leader commit a blank no-op entry into the log at the start of its term. Second,a leader must check whether it has been deposed before processing a read-only request (its information may be stale if a more recent leader has been elected). Raft handles this by having the leader exchange heartbeat messages with a majority of the cluster before responding to read-only requests.</p>
</blockquote>
<p>ETCD implements <code>ReadIndex</code> read(more info on <a href="/posts/diving-into-etcd-linearizable/" rel="">Diving into ETCD’s linearizable reads</a>).</p>
<h3 id="how-etcd-is-using-bbolt">How ETCD is using bbolt</h3>
<p><a href="https://github.com/etcd-io/bbolt" target="_blank" rel="noopener noreffer ">bbolt</a> is the underlying kv used in etcd. <a href="https://github.com/etcd-io/etcd/blob/v3.4.14/mvcc/kvstore_txn.go#L214" target="_blank" rel="noopener noreffer ">A bucket called <code>key</code> is used to store data, and the key is the revision</a>. Then, to find keys, <a href="https://github.com/etcd-io/etcd/blob/v3.4.14/mvcc/index.go#L68" target="_blank" rel="noopener noreffer ">a B-Tree is used</a>.</p>
<blockquote>
<ul>
<li>Bolt allows only one read-write transaction at a time but allows as many read-only transactions as you want at a time.</li>
<li>Each transaction has a consistent view of the data as it existed when the transaction started.</li>
<li>Bolt uses a B+tree internally and only a single file. Both approaches have trade-offs.</li>
<li>If you require a high random write throughput (&gt;10,000 w/sec) or you need to use spinning disks then LevelDB could be a good choice. If your application is read-heavy or does a lot of range scans then Bolt could be a good choice.</li>
<li>Try to avoid long running read transactions. Bolt uses copy-on-write so old pages cannot be reclaimed while an old transaction is using them.</li>
<li>Bolt uses a memory-mapped file so the underlying operating system handles the caching of the data. Typically, the OS will cache as much of the file as it can in memory and will release memory as needed to other processes. This means that Bolt can show very high memory usage when working with large databases.</li>
<li>Etcd implements multi-version-concurrency-control (MVCC) on top of Boltdb</li>
</ul>
</blockquote>
<p><a href="https://github.com/etcd-io/etcd/issues/12169#issuecomment-673292122" target="_blank" rel="noopener noreffer ">From an Github issue</a>:</p>
<blockquote>
<p>Note that the underlying <code>bbolt</code> mmap its file in memory. For better performance, usually it is a good idea to ensure the physical memory available to etcd is larger than its data size.</p>
</blockquote>
<h2 id="etcd-in-k8s">ETCD in K8S</h2>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">We built Kubernetes upon Etcd due to its similarities to Chubby and to the Omega store. When we exposed Etcd&#39;s watch (<a href="https://t.co/7rdNCKHjbO">https://t.co/7rdNCKHjbO</a>) through the K8s API, we let more Etcd details bleed through than originally intended. We need to clean up some of those details soon</p>&mdash; Brian Grant (@bgrant0607) <a href="https://twitter.com/bgrant0607/status/1118273986956120064?ref_src=twsrc%5Etfw">April 16, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/storage/interfaces.go#L159" target="_blank" rel="noopener noreffer ">The interface can be found here</a>.</p>
<ul>
<li>Create use TTL and Txn</li>
<li>Get use KV.Get</li>
<li>Delete use Get and then for with a Txn</li>
<li>GuaranteedUpdate uses Txn</li>
<li>List uses Get</li>
<li>Watch uses Watch with a channel</li>
</ul>
<h2 id="jepsen">Jepsen</h2>
<p>The Jepsen team tested <a href="https://jepsen.io/analyses/etcd-3.4.3" target="_blank" rel="noopener noreffer ">etcd-3.4.3</a>, here&rsquo;s some quotes:</p>
<blockquote>
<p>In our tests, etcd 3.4.3 lived up to its claims for key-value operations: we observed nothing but strict-serializable consistency for reads, writes, and even multi-key transactions, during process pauses, crashes, clock skew, network partitions, and membership changes.</p>
</blockquote>
<blockquote>
<p>Watches appear correct, at least over single keys. So long as compaction does not destroy historical data while a watch isn’t running, watches appear to deliver every update to a key in order.</p>
</blockquote>
<blockquote>
<p>However, etcd locks (like all distributed locks) do not provide mutual exclusion. Multiple processes can hold an etcd lock concurrently, even in healthy clusters with perfectly synchronized clocks.</p>
</blockquote>
<blockquote>
<p>If you use etcd locks, consider whether those locks are used to ensure safety, or simply to improve performance by probabilistically limiting concurrency. It’s fine to use etcd locks for performance, but using them for safety might be risky.</p>
</blockquote>
<h2 id="operation-notes">Operation notes</h2>
<h3 id="deployements-tips">Deployements tips</h3>
<p><a href="https://etcd.io/docs/v3.4.0/faq/" target="_blank" rel="noopener noreffer ">From the official documentation</a>:</p>
<blockquote>
<p>Since etcd writes data to disk, SSD is highly recommended.
To prevent performance degradation or unintentionally overloading the key-value store, etcd enforces a configurable storage size quota set to 2GB by default.
To avoid swapping or running out of memory, the machine should have at least as much RAM to cover the quota.
8GB is a suggested maximum size for normal environments and etcd warns at startup if the configured value exceeds it.</p>
</blockquote>
<h3 id="defrag">Defrag</h3>
<blockquote>
<p>After compacting the keyspace, the backend database may exhibit internal fragmentation.
Defragmentation is issued on a per-member so that cluster-wide latency spikes may be avoided.</p>
</blockquote>
<p>Defrag is basically <a href="https://github.com/etcd-io/etcd/blob/2b79442d8e9fc54b1ac27e7e230ac0e4c132a054/mvcc/backend/backend.go#L349" target="_blank" rel="noopener noreffer ">dumping the bbolt tree on disk and reopening it</a>.</p>
<h3 id="snapshot">Snapshot</h3>
<p>An ETCD snapshot is related to Raft&rsquo;s snapshot:</p>
<blockquote>
<p>Snapshotting is the simplest approach to compaction. In snapshotting, the entire current system state is written to a snapshot on stable storage, then the entire log up to that point is discarded</p>
</blockquote>
<p>Snapshot can be saved using <code>etcdctl</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">etcdctl snapshot save backup.db
</span></span></code></pre></div><h3 id="lease-1">Lease</h3>
<p>Be careful on Leader&rsquo;s change and lease, this can <a href="https://github.com/kubernetes/kubernetes/issues/65497" target="_blank" rel="noopener noreffer ">create some issues</a>:</p>
<blockquote>
<p>The new leader extends timeouts automatically for all leases. This mechanism ensures no lease expires due to server side unavailability.</p>
</blockquote>
<h3 id="war-stories">War stories</h3>
<ul>
<li><a href="https://blog.cloudflare.com/a-byzantine-failure-in-the-real-world/" target="_blank" rel="noopener noreffer ">An analysis of the Cloudflare API availability incident on 2020-11-02</a></li>
<li><a href="https://grafana.com/blog/2020/04/07/how-a-production-outage-in-grafana-clouds-hosted-prometheus-service-was-caused-by-a-bad-etcd-client-setup/" target="_blank" rel="noopener noreffer ">How a production outage in Grafana Cloud&rsquo;s Hosted Prometheus service was caused by a bad etcd client setup</a></li>
<li><a href="https://github.com/etcd-io/etcd/issues/11884" target="_blank" rel="noopener noreffer ">Random performance issue on etcd 3.4</a></li>
<li><a href="https://arxiv.org/pdf/2004.00372.pdf" target="_blank" rel="noopener noreffer ">Impact of etcd deployment on Kubernetes, Istio, and application performance</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-01-11</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://pierrezemb.fr/posts/notes-about-etcd/" data-title="Notes about ETCD" data-via="PierreZ"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://pierrezemb.fr/posts/notes-about-etcd/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://pierrezemb.fr/posts/notes-about-etcd/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://pierrezemb.fr/posts/notes-about-etcd/" data-title="Notes about ETCD"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://pierrezemb.fr/posts/notes-about-etcd/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://pierrezemb.fr/posts/notes-about-etcd/" data-title="Notes about ETCD"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://pierrezemb.fr/posts/notes-about-etcd/" data-title="Notes about ETCD"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/ten-years-programming/" class="prev" rel="prev" title="10 years of programming and counting 🚀"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>10 years of programming and counting 🚀</a>
            <a href="/posts/crafting-keys-in-fdb/" class="next" rel="next" title="Crafting row keys in FoundationDB">Crafting row keys in FoundationDB<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.110.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2015 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Pierre Zemb</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
