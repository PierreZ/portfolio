<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Notes about FoundationDB - Pierre Zemb</title><meta name="Description" content="List of ressources gleaned about FoundationDB"><meta property="og:title" content="Notes about FoundationDB" />
<meta property="og:description" content="List of ressources gleaned about FoundationDB" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pierrezemb.fr/posts/notes-about-foundationdb/" /><meta property="og:image" content="https://pierrezemb.fr/posts/notes-about-foundationdb/images/fdb-white.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-30T10:24:27+01:00" />
<meta property="article:modified_time" content="2020-01-30T10:24:27+01:00" /><meta property="og:site_name" content="Pierre Zemb" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://pierrezemb.fr/posts/notes-about-foundationdb/images/fdb-white.jpg" /><meta name="twitter:title" content="Notes about FoundationDB"/>
<meta name="twitter:description" content="List of ressources gleaned about FoundationDB"/>
<meta name="twitter:site" content="@PierreZ"/>
<meta name="application-name" content="Pierre Zemb">
<meta name="apple-mobile-web-app-title" content="Pierre Zemb"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest">
<link rel="canonical" href="https://pierrezemb.fr/posts/notes-about-foundationdb/" />
<link rel="prev" href="https://pierrezemb.fr/posts/diving-into-kafka-protocol/" /><link rel="next" href="https://pierrezemb.fr/posts/hbase-custom-data-balancing/" /><link rel="stylesheet" href="/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css" integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script defer data-domain="pierrezemb.fr" src="https://plausible.io/js/plausible.js"></script><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Notes about FoundationDB",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/pierrezemb.fr\/posts\/notes-about-foundationdb\/"
        },"genre": "posts","wordcount":  2329 ,
        "url": "https:\/\/pierrezemb.fr\/posts\/notes-about-foundationdb\/","datePublished": "2020-01-30T10:24:27+01:00","dateModified": "2020-01-30T10:24:27+01:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Pierre Zemb"
            },"description": "List of ressources gleaned about FoundationDB"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Pierre Zemb"><span class="header-title-pre">üë®‚Äçüíª</span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/posts/"> Blog </a><a class="menu-item" href="/podcasts/">Ô∏è Podcasts </a><a class="menu-item" href="/talks/"> Talks </a><a class="menu-item" href="/categories/">Ô∏è Categories </a><a class="menu-item" href="/cv.pdf"> Resume </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Pierre Zemb"><span class="header-title-pre">üë®‚Äçüíª</span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/posts/" title="">Blog</a><a class="menu-item" href="/podcasts/" title="">Ô∏èPodcasts</a><a class="menu-item" href="/talks/" title="">Talks</a><a class="menu-item" href="/categories/" title="">Ô∏èCategories</a><a class="menu-item" href="/cv.pdf" title="">Resume</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Notes about FoundationDB</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Pierre Zemb</a></span>&nbsp;<span class="post-category">included in <a href="/categories/foundationdb/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>FoundationDB</a>&nbsp;<a href="/categories/notesabout/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>notesabout</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2020-01-30">2020-01-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2329 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;11 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#overview-of-foundationdb">Overview of FoundationDB</a></li>
    <li><a href="#the-story">The story</a></li>
    <li><a href="#tooling-before-coding">Tooling before coding</a>
      <ul>
        <li><a href="#flow">Flow</a></li>
        <li><a href="#simulation-driven-development">Simulation-Driven development</a></li>
        <li><a href="#known-limitations">Known limitations</a></li>
        <li><a href="#recap">Recap</a></li>
      </ul>
    </li>
    <li><a href="#the-architecture">The Architecture</a>
      <ul>
        <li><a href="#microservices">Microservices</a></li>
        <li><a href="#read-and-write-path">Read and Write Path</a></li>
        <li><a href="#recovery">Recovery</a></li>
        <li><a href="#the-5-second-transaction-limit">The 5-second transaction limit</a></li>
        <li><a href="#ratekeeper">Ratekeeper</a></li>
        <li><a href="#storage">Storage</a></li>
      </ul>
    </li>
    <li><a href="#developer-experience">Developer experience</a></li>
    <li><a href="#fdb-one-more-things-layers">FDB One more things: Layers</a>
      <ul>
        <li><a href="#concept-of-layers">Concept of layers</a></li>
        <li><a href="#apples-record-layer">Apple&rsquo;s Record Layer</a></li>
      </ul>
    </li>
    <li><a href="#kubernetes-operators">Kubernetes Operators</a>
      <ul>
        <li><a href="#overview-of-the-operator">Overview of the operator</a></li>
        <li><a href="#combining-chaos-mesh-and-the-operator">Combining chaos-mesh and the operator</a></li>
      </ul>
    </li>
    <li><a href="#roadmap">Roadmap</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/fdb-white.jpg"
        data-srcset="/posts/notes-about-foundationdb/images/fdb-white.jpg, /posts/notes-about-foundationdb/images/fdb-white.jpg 1.5x, /posts/notes-about-foundationdb/images/fdb-white.jpg 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/fdb-white.jpg"
        title="fdb image" /></p>
<p><a href="/tags/notesabout/" rel="">Notes About</a> is a blogpost serie  you will find a lot of <strong>links, videos, quotes, podcasts to click on</strong> about a specific topic. Today we will discover FoundationDB.</p>
<hr>
<h2 id="overview-of-foundationdb">Overview of FoundationDB</h2>
<p>As stated in the <a href="https://apple.github.io/foundationdb/index.html" target="_blank" rel="noopener noreffer ">official documentation</a>:</p>
<blockquote>
<p>FoundationDB is a distributed database designed to handle large volumes of structured data across clusters of commodity servers. It organizes data as an ordered key-value store and employs ACID transactions for all operations. It is especially well-suited for read/write workloads but also has excellent performance for write-intensive workloads.</p>
</blockquote>
<p>It has strong key points:</p>
<ul>
<li>Multi-model data store</li>
<li>Easily scalable and fault tolerant</li>
<li>Industry-leading performance</li>
<li>Open source.</li>
</ul>
<p>From a database dialect, it provides:</p>
<ul>
<li><a href="https://jepsen.io/consistency/models/strict-serializable" target="_blank" rel="noopener noreffer ">strict serializability</a>(operations appear to have occurred in some order),</li>
<li><a href="https://cloud.google.com/spanner/docs/true-time-external-consistency" target="_blank" rel="noopener noreffer ">external consistency</a>(For any two transactions, T1 and T2, if T2 starts to commit after T1 finishes committing, then the timestamp for T2 is greater than the timestamp for T1).</li>
</ul>
<p><strong>And this is THE tweet that triggered a lot of curiosity on my side:</strong></p>

<h2 id="the-story">The story</h2>
<p>FoundationDB started as a company in 2009, and then <a href="https://techcrunch.com/2015/03/24/apple-acquires-durable-database-company-foundationdb/" target="_blank" rel="noopener noreffer ">has been acquired in 2015 by Apple</a>. It <a href="https://news.ycombinator.com/item?id=9259986" target="_blank" rel="noopener noreffer ">was a bad public publicity for the database as the download were removed.</a></p>
<p>On April 19, 2018, Apple <a href="https://www.foundationdb.org/blog/foundationdb-is-open-source/" target="_blank" rel="noopener noreffer ">open sourced the software, releasing it under the Apache 2.0 license</a>.</p>
<h2 id="tooling-before-coding">Tooling before coding</h2>
<h3 id="flow">Flow</h3>
<p>From the <a href="https://apple.github.io/foundationdb/engineering.html" target="_blank" rel="noopener noreffer ">Engineering page</a>:</p>
<blockquote>
<p>FoundationDB began with ambitious goals for both high performance per node and scalability. We knew that to achieve these goals we would face serious engineering challenges that would require tool breakthroughs. We‚Äôd need efficient asynchronous communicating processes like in Erlang or the Async in .NET, but we‚Äôd also need the raw speed, I/O efficiency, and control of C++. To meet these challenges, we developed several new tools, the most important of which is <strong>Flow</strong>, a new programming language that brings actor-based concurrency to C++11.</p>
</blockquote>
<p>Flow is more of a <strong>stateful distributed system framework</strong> than an asynchronous library. It takes a number of highly opinionated stances on how the overall distributed system should be written, and isn‚Äôt trying to be a widely reusable building block.</p>
<blockquote>
<p>Flow adds about 10 keywords to C++11 and is technically a trans-compiler: the Flow compiler reads Flow code and compiles it down to raw C++11, which is then compiled to a native binary with a traditional toolchain.</p>
</blockquote>
<p>Flow was developed before FDB, as stated in this <a href="https://news.ycombinator.com/item?id=5319163" target="_blank" rel="noopener noreffer ">2013&rsquo;s post</a>:</p>
<blockquote>
<p>FoundationDB founder here. Flow sounds crazy. What hubris to think that you need a new programming language for your project? Three years later: Best decision we ever made.</p>
</blockquote>
<blockquote>
<p>We knew this was going to be a long project so we invested heavily in tools at the beginning. The first two weeks of FoundationDB were building this new programming language to give us the speed of C++ with high level tools for actor-model concurrency. But, the real magic is how Flow enables us to use our real code to do deterministic simulations of a cluster in a single thread. We have a white paper upcoming on this.</p>
</blockquote>
<blockquote>
<p>We&rsquo;ve had quite a bit of interest in Flow over the years and I&rsquo;ve given several talks on it at meetups/conferences. We&rsquo;ve always thought about open-sourcing it&hellip; It&rsquo;s not as elegant as some other actor-model languages like Scala or Erlang (see: C++) but it&rsquo;s nice and fast at run-time and really helps productivity vs. writing callbacks, etc.</p>
</blockquote>
<blockquote>
<p>(Fun fact: We&rsquo;ve only ever found two bugs in Flow. After the first, we decided that we never wanted a bug again in our programming language. So, we built a program in Python that generates random Flow code and independently-executes it to validate Flow&rsquo;s behavior. This fuzz tester found one more bug, and we&rsquo;ve never found another.)</p>
</blockquote>
<p>A very good overview of Flow is available <a href="https://apple.github.io/foundationdb/flow.html" target="_blank" rel="noopener noreffer ">here</a> and some details <a href="https://forums.foundationdb.org/t/why-was-flow-developed/1711/3" target="_blank" rel="noopener noreffer ">here</a>.</p>
<h3 id="simulation-driven-development">Simulation-Driven development</h3>
<p>One of Flow‚Äôs most important job is enabling <strong>Simulation</strong>:</p>
<blockquote>
<p>We wanted FoundationDB to survive failures of machines, networks, disks, clocks, racks, data centers, file systems, etc., so we created a simulation framework closely tied to Flow. By replacing physical interfaces with shims, replacing the main epoll-based run loop with a time-based simulation, and running multiple logical processes as concurrent Flow Actors, Simulation is able to conduct a deterministic simulation of an entire FoundationDB cluster within a single-thread! Even better, we are able to execute this simulation in a deterministic way, enabling us to reproduce problems and add instrumentation ex post facto. This incredible capability enabled us to build FoundationDB exclusively in simulation for the first 18 months and ensure exceptional fault tolerance long before it sent its first real network packet. For a database with as strong a contract as the FoundationDB, testing is crucial, and over the years we have run the equivalent of a trillion CPU-hours of simulated stress testing.</p>
</blockquote>
<p>A good overview of the simulation can be found <a href="https://apple.github.io/foundationdb/testing.html" target="_blank" rel="noopener noreffer ">here</a>. You can also have a look at this awesome talk!</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/4fFDFbi3toc" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Simulation has been made possible by combining:</p>
<ul>
<li>Single-threaded pseudo-concurrency,</li>
<li>Simulated implementation of all external communication,</li>
<li>determinism.</li>
</ul>
<p>Here&rsquo;s an example of a <a href="https://github.com/apple/foundationdb/blob/master/tests/slow/SwizzledCycleTest.txt" target="_blank" rel="noopener noreffer ">testfile</a>:</p>
<pre tabindex="0"><code>testTitle=SwizzledCycleTest
    testName=Cycle
    transactionsPerSecond=5000.0
    testDuration=30.0
    expectedRate=0.01

    testName=RandomClogging
    testDuration=30.0
    swizzle = 1

    testName=Attrition
    machinesToKill=10
    machinesToLeave=3
    reboot=true
    testDuration=30.0

    testName=Attrition
    machinesToKill=10
    machinesToLeave=3
    reboot=true
    testDuration=30.0

    testName=ChangeConfig
    maxDelayBeforeChange=30.0
    coordinators=auto
</code></pre><p>The test is splitted into two parts:</p>
<ul>
<li>
<p><strong>The goal</strong>, for example doing transaction pointing to another with thousands of transactions per sec and there should be only 0.01% of success.</p>
</li>
<li>
<p><strong>What will be done to try to prevent the test to succeed</strong>. In this example it will <strong>at the same time</strong>:</p>
<ul>
<li>do random clogging. Which means that <strong>network connections will be stopped</strong> (preventing actors to send and receive packets). Swizzle flag means that a subset of network connections will be stopped and bring back in reverse order, üò≥</li>
<li>will <strong>poweroff/reboot machines</strong> (attritions) pseudo-randomly while keeping a minimal of three machines, ü§Ø</li>
<li><strong>change configuration</strong>, which means a coordination changes through multi-paxos for the whole cluster. üò±</li>
</ul>
</li>
</ul>
<p>Keep in mind that all these failures will appears <strong>at the same time!</strong> Do you think that your current <strong>datastore has gone through the same test on a daily basis?</strong> <a href="https://github.com/etcd-io/etcd/pull/11308" target="_blank" rel="noopener noreffer ">I think not</a>.</p>
<p>Applications written using the FoundationDB simulator have hierarchy: <code>DataCenter -&gt; Machine -&gt; Process -&gt; Interface</code>. <strong>Each of these can be killed/freezed/nuked</strong>. Even faulty admin commands fired by some DevOps are tested!</p>
<h3 id="known-limitations">Known limitations</h3>
<p>Limitations are well described in the <a href="https://apple.github.io/foundationdb/known-limitations.html" target="_blank" rel="noopener noreffer ">official documentation</a>.</p>
<h3 id="recap">Recap</h3>
<p>An awesome recap is available on the <a href="https://softwareengineeringdaily.com/2019/07/01/foundationdb-with-ryan-worl/" target="_blank" rel="noopener noreffer ">Software Engineering Daily podcast</a>:</p>
<blockquote>
<p>FoundationDB is tested in a very rigorous way using what&rsquo;s called <strong>a deterministic simulation</strong>. The reason they needed a new programming language to do this, is that to get a deterministic simulation, you have to make something that is deterministic. It&rsquo;s kind of obvious, but it&rsquo;s hard to do.</p>
</blockquote>
<blockquote>
<p>For example, if your process interacts with the network, or disks, or clocks, it&rsquo;s not deterministic. If you have multiple threads, not deterministic. So, they needed a way to write a concurrent program that could talk with networks and disks and that type of thing. They needed a way to write a concurrent program that does all of those things that you would think are non-deterministic in a deterministic way.</p>
</blockquote>
<blockquote>
<p>So, all FoundationDB processes, and FoundationDB, it&rsquo;s basically all written in Flow except a very small amount of it from the SQLite B-tree. The reason why that was useful is that when you use Flow, you get all of these higher level abstraction that let what you do what feels to you like asynchronous stuff, but under the hood, it&rsquo;s all implemented using callbacks in C++, which you can make deterministic by running it in a single thread. So, there&rsquo;s a scheduler that just calls these callbacks one after another and it&rsquo;s very crazy looking C++ code, like you wouldn&rsquo;t want to read it, but it&rsquo;s because of Flow they were able to implement that deterministic simulation.</p>
</blockquote>
<h2 id="the-architecture">The Architecture</h2>
<p>According to the <a href="https://apple.github.io/foundationdb/administration.html#fdbmonitor-and-fdbserver" target="_blank" rel="noopener noreffer ">fdbmonitor and fdbserver</a>:</p>
<blockquote>
<p>The core FoundationDB server process is <code>fdbserver</code>. Each <code>fdbserver</code> process uses up to one full CPU core, so a production FoundationDB cluster will usually run N such processes on an N-core system.</p>
</blockquote>
<blockquote>
<p>To make configuring, starting, stopping, and restarting fdbserver processes easy, FoundationDB also comes with a singleton daemon process, <code>fdbmonitor</code>, which is started automatically on boot. <code>fdbmonitor</code> reads the <code>foundationdb.conf</code> file and starts the configured set of fdbserver processes. It is also responsible for starting backup-agent.</p>
</blockquote>
<p>The whole architecture is designed to automatically:</p>
<ul>
<li>load-balanced data and traffic,</li>
<li>self-healing.</li>
</ul>
<h3 id="microservices">Microservices</h3>
<p>A typical FDB cluster is composed of different actors which are describe <a href="https://github.com/apple/foundationdb/blob/master/documentation/sphinx/source/kv-architecture.rst" target="_blank" rel="noopener noreffer ">here</a>.</p>
<p>The most important role in FDB is the <code>Coordinator</code>, it uses <code>Paxos</code> to manage membership on a quorum to do writes. The <code>Coordinator</code> is mostly only used to elect some peers and during recovery. You can view it as a Zookeeper-like stack.</p>
<p>The Coordinator starts by electing a <code>Cluster Controller</code>. It provides administratives informations about the cluster(I have 4 storage processes). Every process needs to register to the <code>Cluster Controller</code> and then it will assign roles to them. It is the one that will heart-beat all the processes.</p>
<p>Then a <code>Master</code> is elected. The <code>Master</code> process is reponsible for the <code>data distribution</code> algorithms. Fun fact, the mapping between keys and storage servers is stored within FDB, which is you can actually move data by running transactions like any other application. He is also the one providing <code>read versions</code> and <code>version number</code> internally. He is also acting as the <code>RateKeeper</code>.</p>
<p><code>The Proxies</code> are responsible for providing read versions, committing transactions, and tracking the storage servers responsible for each range of keys.</p>
<p><code>The Transaction Resolvers</code> are responsible determining conflicts between transactions. A transaction conflicts if it reads a key that has been written between the transaction‚Äôs read version and commit version. The resolver does this by holding the last 5 seconds of committed writes in memory, and comparing a new transaction‚Äôs reads against this set of commits.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/architecture.png"
        data-srcset="/posts/notes-about-foundationdb/images/architecture.png, /posts/notes-about-foundationdb/images/architecture.png 1.5x, /posts/notes-about-foundationdb/images/architecture.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/architecture.png"
        title="fdb image" /></p>
<h3 id="read-and-write-path">Read and Write Path</h3>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/EMwhsGsxfPU" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h4 id="read-path">Read Path</h4>
<ol>
<li>Retrieve a consistend read version for the transaction</li>
<li>Do reads from a consistent MVCC snapshot at that read version on the storage node</li>
</ol>
<h4 id="write-path">Write Path</h4>
<ol>
<li>client is sending a bundle to the <code>proxy</code> containing:
<ul>
<li>read version for the transaction</li>
<li>every readen key</li>
<li>every mutation that you want to do</li>
</ul>
</li>
<li>The proxy will assign a <code>Commit version</code> to a batch of transactions. <code>Commit version</code> is generated by the <code>Master</code></li>
<li>Proxy is sending to the resolver. This will check if the data that you want to mutate has been changed between your <code>read Version</code> and your <code>Commit version</code>. They are sharded by key-range.</li>
<li>Transaction is made durable within the <code>Transaction Logs</code> by <code>fsync</code>ing the data. Before the data is even written to disk it is forwarded to the <code>storage servers</code> responsible for that mutation. Internally, <code>Transactions Logs</code> are creating <strong>a stream per <code>Storage Server</code></strong>. Once the <code>storage servers</code> have made the mutation durable, they pop it from the log. This generally happens roughly 6 seconds after the mutation was originally committed to the log.</li>
<li><code>Storage servers</code> are lazily updating data on disk from the <code>Transaction logs</code>. They are keeping new write in-memory.</li>
<li><code>Transaction Logs</code> is responding OK to the Proxy and then the proxy is replying OK to the client.</li>
</ol>
<p>You can find more diagrams about transactions <a href="https://forums.foundationdb.org/t/technical-overview-of-the-database/135/3" target="_blank" rel="noopener noreffer ">here</a>.</p>
<h3 id="recovery">Recovery</h3>
<p>Recovery processes are detailled at around 25min.</p>
<p>During failure of a process (Except storage servers), the systems will try to create a new <code>generation</code>, so new <code>Master</code>, <code>proxies</code>, <code>resolvers</code> and <code>transactions logs</code>. New master will get a read version from transactions logs, and commit with <code>Paxos</code> the fact that starting from <code>Read version</code>, the new generation is the one in charge.</p>
<p><code>Storage servers</code> are replicating data on failures.</p>
<h3 id="the-5-second-transaction-limit">The 5-second transaction limit</h3>
<p>FoundationDB currently does not support transactions running for over five seconds. More details around 16min but the <code>tl;dr</code> is:</p>
<ul>
<li>Storage servers are caching latest read in-memory,</li>
<li>Resolvers are caching the last 5 seconds transactions.</li>
</ul>
<h3 id="ratekeeper">Ratekeeper</h3>
<p>More details around 31min but the <code>tl;dr</code> is that when system is saturated, retrieving the <code>Read version</code> is slowed down.</p>
<h3 id="storage">Storage</h3>
<p>A lot of information are available in this talk:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/nlus1Z7TVTI" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<ul>
<li><code>memory</code> is optimized for small databases. Data is stored in memory and logged to disk. In this storage engine, all data must be resident in memory at all times, and all reads are satisfied from memory.</li>
<li><code>SSD</code> Storage Engine is based on SQLite B-Tree</li>
<li><code>Redwood</code> will be a new storage engine based on Versioned B+Tree</li>
</ul>
<h2 id="developer-experience">Developer experience</h2>
<p>FoundationDB‚Äôs keys are ordered, making <code>tuples</code> a particularly useful tool for data modeling. FoundationDB provides a <strong>tuple layer</strong> (available in each language binding) that encodes tuples into keys. This layer lets you store data using a tuple like <code>(state, county)</code> as a key. Later, you can perform reads using a prefix like <code>(state,)</code>. The layer works by preserving the natural ordering of the tuples.</p>
<p>Everything is wrapped into a transaction in FDB.</p>
<p>You can have a nice overview by reading the README of <a href="https://github.com/richardartoul/tsdb-layer/blob/master/README.md" target="_blank" rel="noopener noreffer ">tsdb-layer</a>, an experiment combining Time Series and FoundationDB: Millions of writes/s and 10x compression in under 2,000 lines of Go.</p>
<h2 id="fdb-one-more-things-layers">FDB One more things: Layers</h2>
<h3 id="concept-of-layers">Concept of layers</h3>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/HLE8chgw6LI" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>FDB is resolving many distributed problems, but you still need things like <strong>security, multi-tenancy, query optimizations, schema, indexing</strong>.</p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/extract-layer-1.png"
        data-srcset="/posts/notes-about-foundationdb/images/extract-layer-1.png, /posts/notes-about-foundationdb/images/extract-layer-1.png 1.5x, /posts/notes-about-foundationdb/images/extract-layer-1.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/extract-layer-1.png"
        title="fdb image" /></p>
<hr>
<p>Layers are designed to develop features <strong>above FDB.</strong> The record-layer provided by Apple is a good starting point to build things above it, as it provides <strong>structured schema, indexes, and (async) query planner.</strong></p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/extract-layer-2.png"
        data-srcset="/posts/notes-about-foundationdb/images/extract-layer-2.png, /posts/notes-about-foundationdb/images/extract-layer-2.png 1.5x, /posts/notes-about-foundationdb/images/extract-layer-2.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/extract-layer-2.png"
        title="fdb image" /></p>
<hr>
<p>The record-layer provided by Apple is a good starting point to build things above it, as it provides <strong>structured schema, indexes, and (async) query planner.</strong></p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/extract-layer-3.png"
        data-srcset="/posts/notes-about-foundationdb/images/extract-layer-3.png, /posts/notes-about-foundationdb/images/extract-layer-3.png 1.5x, /posts/notes-about-foundationdb/images/extract-layer-3.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/extract-layer-3.png"
        title="fdb image" /></p>
<h3 id="apples-record-layer">Apple&rsquo;s Record Layer</h3>
<p>The paper is located <a href="https://arxiv.org/pdf/1901.04452.pdf" target="_blank" rel="noopener noreffer ">FoundationDB Record Layer:A Multi-Tenant Structured Datastore</a></p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/SvoUHHM9IKU" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Record Layer was designed to solve CloudKit problem.</p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/record-extract-1.png"
        data-srcset="/posts/notes-about-foundationdb/images/record-extract-1.png, /posts/notes-about-foundationdb/images/record-extract-1.png 1.5x, /posts/notes-about-foundationdb/images/record-extract-1.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/record-extract-1.png"
        title="fdb image" /></p>
<hr>
<p>Record allow multi-tenancy with schema above FDB</p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/record-extract-2.png"
        data-srcset="/posts/notes-about-foundationdb/images/record-extract-2.png, /posts/notes-about-foundationdb/images/record-extract-2.png 1.5x, /posts/notes-about-foundationdb/images/record-extract-2.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/record-extract-2.png"
        title="fdb image" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/record-extract-3.png"
        data-srcset="/posts/notes-about-foundationdb/images/record-extract-3.png, /posts/notes-about-foundationdb/images/record-extract-3.png 1.5x, /posts/notes-about-foundationdb/images/record-extract-3.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/record-extract-3.png"
        title="fdb image" /></p>
<hr>
<p>Record Layers is providing stateless compute</p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/record-extract-4.png"
        data-srcset="/posts/notes-about-foundationdb/images/record-extract-4.png, /posts/notes-about-foundationdb/images/record-extract-4.png 1.5x, /posts/notes-about-foundationdb/images/record-extract-4.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/record-extract-4.png"
        title="fdb image" /></p>
<hr>
<p>And streaming queries!</p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/record-extract-5.png"
        data-srcset="/posts/notes-about-foundationdb/images/record-extract-5.png, /posts/notes-about-foundationdb/images/record-extract-5.png 1.5x, /posts/notes-about-foundationdb/images/record-extract-5.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/record-extract-5.png"
        title="fdb image" /></p>
<hr>
<h2 id="kubernetes-operators">Kubernetes Operators</h2>
<h3 id="overview-of-the-operator">Overview of the operator</h3>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/A3U8M8pt3Ks" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/operator-extract-1.png"
        data-srcset="/posts/notes-about-foundationdb/images/operator-extract-1.png, /posts/notes-about-foundationdb/images/operator-extract-1.png 1.5x, /posts/notes-about-foundationdb/images/operator-extract-1.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/operator-extract-1.png"
        title="fdb image" /></p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/operator-extract-2.png"
        data-srcset="/posts/notes-about-foundationdb/images/operator-extract-2.png, /posts/notes-about-foundationdb/images/operator-extract-2.png 1.5x, /posts/notes-about-foundationdb/images/operator-extract-2.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/operator-extract-2.png"
        title="fdb image" /></p>
<hr>
<p>Upgrade is done by <strong>bumping all processes at once</strong> üò±</p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/operator-extract-3.png"
        data-srcset="/posts/notes-about-foundationdb/images/operator-extract-3.png, /posts/notes-about-foundationdb/images/operator-extract-3.png 1.5x, /posts/notes-about-foundationdb/images/operator-extract-3.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/operator-extract-3.png"
        title="fdb image" /></p>
<hr>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/notes-about-foundationdb/images/operator-extract-4.png"
        data-srcset="/posts/notes-about-foundationdb/images/operator-extract-4.png, /posts/notes-about-foundationdb/images/operator-extract-4.png 1.5x, /posts/notes-about-foundationdb/images/operator-extract-4.png 2x"
        data-sizes="auto"
        alt="/posts/notes-about-foundationdb/images/operator-extract-4.png"
        title="fdb image" /></p>
<h3 id="combining-chaos-mesh-and-the-operator">Combining chaos-mesh and the operator</h3>
<p>I played a bit with the operator by combining:</p>
<ul>
<li><a href="https://github.com/FoundationDB/fdb-kubernetes-operator" target="_blank" rel="noopener noreffer ">FoundationDB/fdb-kubernetes-operator</a></li>
<li><a href="https://github.com/pingcap/go-ycsb" target="_blank" rel="noopener noreffer ">pingcap/go-ycsb</a></li>
<li><a href="https://github.com/pingcap/chaos-mesh" target="_blank" rel="noopener noreffer ">pingcap/chaos-mesh</a></li>
<li><a href="https://github.com/PierreZ/fdb-prometheus-exporter/" target="_blank" rel="noopener noreffer ">PierreZ/fdb-prometheus-exporter</a></li>
</ul>
<p>The experiment is available <a href="https://github.com/PierreZ/fdb-k8s-chaos/" target="_blank" rel="noopener noreffer ">here</a>.</p>
<h2 id="roadmap">Roadmap</h2>
<p><a href="https://github.com/apple/foundationdb/wiki/FoundationDB-Release-7.0-Planning" target="_blank" rel="noopener noreffer ">FoundationDB Release 7.0 Planning</a></p>
<hr>
<p><strong>Thank you</strong> for reading my post! Feel free to react to this article, I am also available on <a href="https://twitter.com/PierreZ" target="_blank" rel="noopener noreffer ">Twitter</a> if needed.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-01-30</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/" data-title="Notes about FoundationDB" data-via="PierreZ"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/" data-title="Notes about FoundationDB"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/" data-title="Notes about FoundationDB"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on ÂæÆÂçö" data-sharer="weibo" data-url="https://pierrezemb.fr/posts/notes-about-foundationdb/" data-title="Notes about FoundationDB"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/diving-into-kafka-protocol/" class="prev" rel="prev" title="Diving into Kafka&#39;s Protocol"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Diving into Kafka's Protocol</a>
            <a href="/posts/hbase-custom-data-balancing/" class="next" rel="next" title="Contributing to Apache HBase: custom data balancing">Contributing to Apache HBase: custom data balancing<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.121.1">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2015 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Pierre Zemb</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"data":{"id-1":"~/blog","id-2":"~/blog"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.d7121d72cd85153ec9d35a888cee3eb28c2700ca763f649a538f6c772d750021.js" integrity="sha256-1xIdcs2FFT7J01qIjO4+sownAMp2P2SaU49sdy11ACE="></script></body>
</html>
